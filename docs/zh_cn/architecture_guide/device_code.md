
再来看一下设备管理模块的具体实现。打开framework/include/nndeploy/device/device.h文件。这是设备管理模块那四个基类device/stream/envet/architeture的定义的头文件。

首先看一下Device，延续传统,先讲成员变量,再讲成员函数。

这里只有一个表明那类设备、几号卡的device_type,因为这是基类,没有具体设备的上下文成员变量，子类才会有关于设备的上下文的设置，看一下Device的成员函数，看看主要完成哪些功能:

首先是内存分配,通过allocate可以分配出该设备下的具体内存,返回的是原始指针。分配内存就需要释放内存。对于cuda/华为昇腾这类设备而言，还可以分配锁页内存, 对应的，就需要释放锁页内存。可以看到这都是虚函数,父类是不实现该函数的,具体的实现需要交给子类去完成。

然后是数据传输相关的接口。首先是裸指针的拷贝,通过copy函数将源数据拷贝给目标数据,需要指定源数据指针src、目标数据指针dst、拷贝的大小size,以及可选的stream参数。当把Host数据拷贝给NPU数据的时候,对于NPU而言,它需要通过stream来完成数据拷贝，当不设置stream时，就一定同步拷贝，host需要等待拷贝完成，才能执行后续的操作。

此外还提供了download和upload函数。download用于从设备端(如NPU)下载数据到主机端(CPU),upload则用于从主机端上传数据到设备端。这些都是针对裸指针的拷贝接口。

为了简化Buffer对象之间的拷贝,Device类还提供了专门的Buffer拷贝接口,包括copy、download和upload。由于Buffer对象本身包含了内存大小等信息,因此这些接口不需要额外指定size参数。这些Buffer拷贝接口在内部实现上,本质还是调用了裸指针的拷贝接口。

然后是获取这个设备的原始的上下文。这是绑定线程,就像在华为昇腾那堂课讲的一样,每个线程有一个主线程,有一个默认的上下文,当切到辅线程的时候,还想继续沿用主线程的上下文,就需要调用binding绑定线程这个接口。

如PPT所讲,device也要提供创建流、销毁流的接口。这是创建事件和管理事件的相关接口。这是返回该device的具体信息是什么,设备是哪一张卡。device的构造函数、析构函数、初始化函数和反初始化函数。对于华为昇腾NPU而言,需要为该设备创建一个自定义的上下文,所以初始化这个动作是在initialize里面做的。有了初始化就会有反初始化。

通过这里就把Device的基类过了一遍。看一下拷贝接口,把数据上传,把数据拷贝,把主机的数据上传给NPU侧,是需要流的存在的。现在再来看一下Stream。

Stream的接口,首先是构造函数,还是看一下成员变量。它是通过某个具体的device创建出来的,把创建的device放进来。这个stream可以是外部的流,也可以是内部自己创建的流,所以它会有一个external_的标志,它默认是等于false的,默认是这个stream会创建自己的流。

看一下Stream的具体设计,它会有哪些函数:这是一些获取信息的函数,同步的函数,标记事件的函数,等待该事件完成的函数,获取原始的流的函数。来看一下stream的成员函数:首先是获得device相关的信息,然后是同步,调用了同步函数之后在stream上所有执行的task都会等待该stream上的所有task完成执行。

这里还有record_event,它可以让执行流在stream的某一个位置绑定某一个具体的事件。例如在流中记录事件,它可以在流中记录某一个事件,从而让另外一个流去等待该事件完成才能执行,实现流之间的同步。

可以看一下例子: